{% extends "index.html" %}

{% block content %}
<div class="timeline-container" style="max-width: 600px; margin: 3em auto; font-family: Arial, sans-serif;">
    <h2>Post to Timeline</h2>

    <form id="timeline-form" style="margin-bottom: 2em;">
        <input type="text" name="name" placeholder="Name" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
        <input type="email" name="email" placeholder="Email" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
        <textarea name="content" placeholder="Write something..." required style="width: 100%; padding: 8px; height: 100px; margin-bottom: 10px;"></textarea><br>
        <button type="submit" style="padding: 8px 16px;">Post</button>
    </form>

    <h2>Timeline Posts</h2>
    <div id="timeline-posts"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<script>
    function getGravatarUrl(email) {
        const hash = md5(email.trim().toLowerCase());
        return `https://www.gravatar.com/avatar/${hash}?d=identicon`;
    }

    function renderPosts(posts) {
        const container = document.getElementById('timeline-posts');
        container.innerHTML = '';
        posts.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.style = "border: 1px solid #ccc; border-radius: 5px; padding: 1em; margin-bottom: 1em; display: flex; gap: 1em;";
            postDiv.innerHTML = `
                <img src="${getGravatarUrl(post.email)}" width="50" height="50" style="border-radius: 50%;">
                <div>
                    <strong>${post.name}</strong> (${post.email})<br>
                    ${post.content}<br>
                    <small>${new Date(post.created_at).toLocaleString()}</small>
                </div>
            `;
            container.appendChild(postDiv);
        });
    }

    async function loadPosts() {
        const res = await fetch('/api/timeline_post');
        const data = await res.json();
        renderPosts(data.timeline_posts);
    }

    document.getElementById('timeline-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const res = await fetch('/api/timeline_post', {
            method: 'POST',
            body: formData
        });
        if (res.ok) {
            form.reset();
            loadPosts();
        } else {
            alert("Error posting timeline entry.");
        }
    });

    loadPosts();
</script>
{% endblock %}
